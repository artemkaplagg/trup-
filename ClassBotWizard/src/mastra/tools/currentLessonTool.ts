import { createTool } from "@mastra/core/tools";
import type { IMastraLogger } from "@mastra/core/logger";
import { z } from "zod";

// –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
const BELL_SCHEDULE = {
  1: { start: "08:30", end: "09:15" },
  2: { start: "09:25", end: "10:10" },
  3: { start: "10:20", end: "11:05" },
  4: { start: "11:35", end: "12:20" },
  5: { start: "12:30", end: "13:15" },
  6: { start: "13:25", end: "14:10" },
  7: { start: "14:20", end: "15:05" },
  8: { start: "15:15", end: "16:00" }
};

// –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø
const SCHEDULE = {
  "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": {
    "group1": [
      { subject: "–ú–∏—Å—Ç–µ—Ü—Ç–≤–æ", room: "206", teacher: "–°–æ—Ä–æ—á–∞–Ω –ù.–Ñ." },
      { subject: "–ë–∏–æ–ª–æ–≥–∏—è", room: "569", teacher: "–õ–∞–≤–æ–∫ –û.–ú." },
      { subject: "–ó–¥–æ—Ä–æ–≤—å–µ", room: "248", teacher: "–ú–∞—Ä—á–µ–Ω–∫–æ –Æ.–û." },
      { subject: "–í—Å–µ–º–∏—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è", room: "203", teacher: "–ó–∞–≥—Ä–µ–±–µ–ª—å–Ω–∞ –õ.–ü." },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", room: "407", teacher: "–ë–∞–±–∞—î–≤—Å—å–∫–∏–π –û–ª–µ–∫—Å–∞–Ω–¥—Ä", group_note: "2 –≥—Ä—É–ø–ø–∞" }
    ],
    "group2": [
      { subject: "–ú–∏—Å—Ç–µ—Ü—Ç–≤–æ", room: "206", teacher: "–°–æ—Ä–æ—á–∞–Ω –ù.–Ñ." },
      { subject: "–ë–∏–æ–ª–æ–≥–∏—è", room: "569", teacher: "–õ–∞–≤–æ–∫ –û.–ú." },
      { subject: "–ó–¥–æ—Ä–æ–≤—å–µ", room: "248", teacher: "–ú–∞—Ä—á–µ–Ω–∫–æ –Æ.–û." },
      { subject: "–í—Å–µ–º–∏—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è", room: "203", teacher: "–ó–∞–≥—Ä–µ–±–µ–ª—å–Ω–∞ –õ.–ü." },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", room: "407", teacher: "–ë–∞–±–∞—î–≤—Å—å–∫–∏–π –û–ª–µ–∫—Å–∞–Ω–¥—Ä", group_note: "2 –≥—Ä—É–ø–ø–∞" }
    ]
  },
  "–í—Ç–æ—Ä–Ω–∏–∫": {
    "group1": [
      { subject: "–ë–∏–æ–ª–æ–≥–∏—è", room: "569", teacher: "–õ–∞–≤–æ–∫ –û.–ú." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", room: "242", teacher: "–ü—Ä–∏—Ö–æ–¥—å–∫–æ –õ.–Ü." },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" },
      { subject: "–§–∏–∑–∏–∫–∞", room: "145", teacher: "–°–∞–ª—ñ–≤–æ–Ω –ù.–ì." }
    ],
    "group2": [
      { subject: "–ë–∏–æ–ª–æ–≥–∏—è", room: "569", teacher: "–õ–∞–≤–æ–∫ –û.–ú." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å", room: "242", teacher: "–ü—Ä–∏—Ö–æ–¥—å–∫–æ –õ.–Ü." },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" },
      { subject: "–§–∏–∑–∏–∫–∞", room: "145", teacher: "–°–∞–ª—ñ–≤–æ–Ω –ù.–ì." }
    ]
  },
  "–°—Ä–µ–¥–∞": {
    "group1": [
      { subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", room: "407", teacher: "–ë–∞–±–∞—î–≤—Å—å–∫–∏–π –û–ª–µ–∫—Å–∞–Ω–¥—Ä", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" },
      { subject: "–•–∏–º–∏—è", room: "428", teacher: "–°–µ–ª–µ–∑–Ω—å–æ–≤–∞ –Æ.–û." },
      { subject: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", room: "502", teacher: "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–∞", group_note: "1 –≥—Ä—É–ø–ø–∞" }
    ],
    "group2": [
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", room: "407", teacher: "–ë–∞–±–∞—î–≤—Å—å–∫–∏–π –û–ª–µ–∫—Å–∞–Ω–¥—Ä", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" },
      { subject: "–•–∏–º–∏—è", room: "428", teacher: "–°–µ–ª–µ–∑–Ω—å–æ–≤–∞ –Æ.–û." },
      { subject: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", room: "502", teacher: "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–∞", group_note: "1 –≥—Ä—É–ø–ø–∞" }
    ]
  },
  "–ß–µ—Ç–≤–µ—Ä–≥": {
    "group1": [
      { subject: "–ò—Å—Ç–æ—Ä–∏—è –£–∫—Ä–∞–∏–Ω—ã", room: "203", teacher: "–ó–∞–≥—Ä–µ–±–µ–ª—å–Ω–∞ –õ.–ü." },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", room: "502", teacher: "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–∞", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ó–∞—Ä—É–±–µ–∂–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "242", teacher: "–ü—Ä–∏—Ö–æ–¥—å–∫–æ –õ.–Ü." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü." },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" }
    ],
    "group2": [
      { subject: "–ò—Å—Ç–æ—Ä–∏—è –£–∫—Ä–∞–∏–Ω—ã", room: "203", teacher: "–ó–∞–≥—Ä–µ–±–µ–ª—å–Ω–∞ –õ.–ü." },
      { subject: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", room: "502", teacher: "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–∞", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ó–∞—Ä—É–±–µ–∂–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "242", teacher: "–ü—Ä–∏—Ö–æ–¥—å–∫–æ –õ.–Ü." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü." },
      { subject: "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", room: "610", teacher: "–û–ª—å—Ö–æ–≤–∏–∫ –ê–Ω–¥—Ä—ñ–π –î–º–∏—Ç—Ä–æ–≤–∏—á" }
    ]
  },
  "–ü—è—Ç–Ω–∏—Ü–∞": {
    "group1": [
      { subject: "STEM", room: "408", teacher: "–ë–æ—Ä–µ—Ü—å–∫–∏–π –ö.–ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü." },
      { subject: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", room: "592", teacher: "–ë–∞–±–µ—â–∞ –°.–í." }
    ],
    "group2": [
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü.", group_note: "2 –≥—Ä—É–ø–ø–∞" },
      { subject: "STEM", room: "408", teacher: "–ë–æ—Ä–µ—Ü—å–∫–∏–π –ö.–ü.", group_note: "1 –≥—Ä—É–ø–ø–∞" },
      { subject: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", room: "410", teacher: "–ì–ª–∏–±–∫–æ –°.–Ü." },
      { subject: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", room: "200", teacher: "–ú–∞–π–¥–∞–Ω –í—ñ–∫—Ç–æ—Ä –Ü–≤–∞–Ω—ñ–≤–Ω–∞" },
      { subject: "–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", room: "335", teacher: "–ë—É—è–ª—å—Å—å–∫–∞ –ù.–Ü." },
      { subject: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", room: "592", teacher: "–ë–∞–±–µ—â–∞ –°.–í." }
    ]
  }
};

export const currentLessonTool = createTool({
  id: "current-lesson-tool",
  description: "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π: üü© - –ø—Ä–æ—à–µ–¥—à–∏–µ —É—Ä–æ–∫–∏, üëà - —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫, üü¶ - –±—É–¥—É—â–∏–µ —É—Ä–æ–∫–∏",
  inputSchema: z.object({
    userGroup: z.number().nullable().describe("–ì—Ä—É–ø–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (1 –∏–ª–∏ 2), null –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"),
    specificDay: z.string().optional().describe("–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π)")
  }),
  outputSchema: z.object({
    currentDay: z.string().describe("–¢–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏"),
    currentTime: z.string().describe("–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è"),
    currentLesson: z.object({
      number: z.number().nullable().describe("–ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–∫–∞"),
      subject: z.string().nullable().describe("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞"),
      timeRange: z.string().nullable().describe("–í—Ä–µ–º—è —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–∫–∞"),
      room: z.string().nullable().describe("–ê—É–¥–∏—Ç–æ—Ä–∏—è"),
      teacher: z.string().nullable().describe("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å")
    }).describe("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–∫–µ"),
    schedule: z.array(z.object({
      number: z.number().describe("–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞"),
      subject: z.string().describe("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"),
      room: z.string().describe("–ê—É–¥–∏—Ç–æ—Ä–∏—è"),
      teacher: z.string().describe("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å"),
      timeRange: z.string().describe("–í—Ä–µ–º—è —É—Ä–æ–∫–∞"),
      status: z.enum(["past", "current", "future"]).describe("–°—Ç–∞—Ç—É—Å —É—Ä–æ–∫–∞"),
      emoji: z.string().describe("–≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞"),
      groupNote: z.string().optional().describe("–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ –≥—Ä—É–ø–ø–µ")
    })).describe("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π"),
    message: z.string().describe("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º")
  }),
  execute: async ({ context: { userGroup, specificDay }, mastra }) => {
    const logger = mastra?.getLogger();
    logger?.info('üïê [CurrentLesson] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–∫–∞', { userGroup, specificDay });

    const now = new Date();
    const currentTime = now.toTimeString().slice(0, 5); // HH:MM
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    const daysOfWeek = ["–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];
    let dayName: string;
    
    if (specificDay) {
      dayName = specificDay;
    } else {
      dayName = daysOfWeek[now.getDay()];
    }

    logger?.info('üìÖ [CurrentLesson] –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–Ω—è', { dayName, currentTime });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
    if (!SCHEDULE[dayName as keyof typeof SCHEDULE]) {
      const message = `üìÖ ${dayName}\nüïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${currentTime}\n\n‚ùå –ù–∞ —Å–µ–≥–æ–¥–Ω—è —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`;
      
      return {
        currentDay: dayName,
        currentTime,
        currentLesson: {
          number: null,
          subject: null,
          timeRange: null,
          room: null,
          teacher: null
        },
        schedule: [],
        message
      };
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const groupKey = userGroup === 2 ? "group2" : "group1"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –≥—Ä—É–ø–ø–∞
    const daySchedule = SCHEDULE[dayName as keyof typeof SCHEDULE][groupKey];

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫
    let currentLessonNumber: number | null = null;
    let currentLessonInfo = {
      number: null as number | null,
      subject: null as string | null,
      timeRange: null as string | null,
      room: null as string | null,
      teacher: null as string | null
    };

    for (const [lessonNum, bellTime] of Object.entries(BELL_SCHEDULE)) {
      const lessonNumber = parseInt(lessonNum);
      const { start, end } = bellTime;
      
      if (currentTime >= start && currentTime <= end) {
        currentLessonNumber = lessonNumber;
        const lessonData = daySchedule[lessonNumber - 1];
        if (lessonData) {
          currentLessonInfo = {
            number: lessonNumber,
            subject: lessonData.subject,
            timeRange: `${start} - ${end}`,
            room: lessonData.room,
            teacher: lessonData.teacher
          };
        }
        break;
      }
    }

    // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
    const scheduleWithStatus = daySchedule.map((lesson, index) => {
      const lessonNumber = index + 1;
      const bellTime = BELL_SCHEDULE[lessonNumber as keyof typeof BELL_SCHEDULE];
      const timeRange = `${bellTime.start} - ${bellTime.end}`;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Ä–æ–∫–∞
      let status: "past" | "current" | "future";
      let emoji: string;
      
      if (lessonNumber === currentLessonNumber) {
        status = "current";
        emoji = "üëà";
      } else if (currentTime > bellTime.end) {
        status = "past";
        emoji = "üü©";
      } else {
        status = "future";
        emoji = "üü¶";
      }

      return {
        number: lessonNumber,
        subject: lesson.subject,
        room: lesson.room,
        teacher: lesson.teacher,
        timeRange,
        status,
        emoji,
        groupNote: (lesson as any).group_note
      };
    });

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const groupText = userGroup ? `${userGroup}-—è –≥—Ä—É–ø–ø–∞` : "1-—è –≥—Ä—É–ø–ø–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)";
    let message = `üìÖ ${dayName} (${groupText})\nüïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${currentTime}\n\n`;
    
    if (currentLessonNumber) {
      message += `üîî –°–µ–π—á–∞—Å –∏–¥–µ—Ç ${currentLessonNumber} —É—Ä–æ–∫:\n`;
      message += `${currentLessonInfo.subject} (${currentLessonInfo.timeRange})\n`;
      message += `üè´ –ö–∞–±–∏–Ω–µ—Ç: ${currentLessonInfo.room}\n`;
      message += `üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å: ${currentLessonInfo.teacher}\n\n`;
    } else {
      message += `‚è∏Ô∏è –°–µ–π—á–∞—Å –Ω–µ—Ç —É—Ä–æ–∫–æ–≤\n\n`;
    }

    message += `üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å:\n\n`;
    
    scheduleWithStatus.forEach((lesson) => {
      const groupNoteText = lesson.groupNote ? ` (${lesson.groupNote})` : "";
      message += `${lesson.emoji} ${lesson.number}. ${lesson.subject}${groupNoteText}\n`;
      message += `   ‚è∞ ${lesson.timeRange}\n`;
      message += `   üè´ –ö–∞–±–∏–Ω–µ—Ç: ${lesson.room}\n`;
      message += `   üë®‚Äçüè´ ${lesson.teacher}\n\n`;
    });

    message += `\nüü© - –ø—Ä–æ—à–µ–¥—à–∏–µ —É—Ä–æ–∫–∏\nüëà - —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫\nüü¶ - –±—É–¥—É—â–∏–µ —É—Ä–æ–∫–∏`;

    logger?.info('‚úÖ [CurrentLesson] –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ', { 
      dayName, 
      currentLessonNumber, 
      totalLessons: scheduleWithStatus.length 
    });

    return {
      currentDay: dayName,
      currentTime,
      currentLesson: currentLessonInfo,
      schedule: scheduleWithStatus,
      message
    };
  },
});